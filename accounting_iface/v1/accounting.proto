syntax = "proto3";
package accounting_iface.v1;

import "buf/validate/validate.proto";
import "common/v1/common.proto";

option go_package = "github.com/pdcgo/schema/services/accounting_iface/v1;accounting_iface";

// Service untuk accouting rekening
service AccountService {
  rpc AccountCreate(AccountCreateRequest) returns (AccountCreateResponse);
  rpc AccountList(AccountListRequest) returns (AccountListResponse);
  rpc AccountDelete(AccountDeleteRequest) returns (AccountDeleteResponse);
  rpc AccountUpdate(AccountUpdateRequest) returns (AccountUpdateResponse);
  rpc LabelList(LabelListRequest) returns (LabelListResponse);
  rpc AccountTypeList(AccountTypeListRequest) returns (AccountTypeListResponse);

  rpc AccountByIDs(AccountByIDsRequest) returns (AccountByIDsResponse);
  rpc AccountPublicSearch(AccountPublicSearchRequest) returns (AccountPublicSearchResponse);
  // permission kosiong admin list

  // balance
  rpc AccountBalanceInit(AccountBalanceInitRequest) returns (AccountBalanceInitResponse);

  // untuk transfer ke account lain
  rpc TransferCreate(TransferCreateRequest) returns (TransferCreateResponse);
  rpc TransferCancel(TransferCancelRequest) returns (TransferCancelResponse);
  rpc AccountMutationList(AccountMutationListRequest) returns (AccountMutationListResponse);
}

message AccountByIDsRequest {
  repeated uint64 ids = 1 [(buf.validate.field).repeated = {
    min_items: 1 // must have at least 1 id
    max_items: 200
    unique: true // no duplicate IDs allowed
    items: {
      uint64: {gt: 0}
    }
  }];
}
message AccountByIDsResponse {
  map<uint64, PublicAccountItem> data = 1;
}

message AccountPublicSearchRequest {
  uint64 team_id = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).uint64.gt = 0
  ];
  string keyword = 2;
}

message AccountPublicSearchResponse {
  repeated PublicAccountItem data = 1;
}

message TransferCancelRequest {}
message TransferCancelResponse {}

enum MutationType {
  MUTATION_TYPE_UNSPECIFIED = 0;
  MUTATION_TYPE_SEND = 1;
  MUTATION_TYPE_RECEIVE = 2;
}

message MutationItem {
  uint64 id = 1;
  uint64 team_id = 10;
  uint64 from_account_id = 11;
  uint64 to_account_id = 12;
  MutationType type = 2;
  double fee_amount = 3;
  double amount = 4;
  string desc = 5;
  // int64 transfer_at = 6;
  int64 created = 7;
  // @gotags: gorm:"-"
  PublicAccountItem from_account = 8;
  // @gotags: gorm:"-"
  PublicAccountItem to_account = 9;
}

message AccountMutationListRequest {
  uint64 team_id = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).uint64.gt = 0
  ];
  uint64 account_id = 2;
  common.v1.TimeFilter time_range = 3;
  common.v1.PageFilter page = 4;
}
message AccountMutationListResponse {
  repeated MutationItem data = 1;
  common.v1.PageInfo page_info = 2;
}

message AccountBalanceInitRequest {
  uint64 account_id = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).uint64.gt = 0
  ];

  double amount = 2 [(buf.validate.field).double.gt = 0];
  string desc = 3 [(buf.validate.field).string.max_len = 255];
}

message AccountBalanceInitResponse {}

message TransferCreateRequest {
  uint64 team_id = 1 [
    (buf.validate.field).required = true,
    (buf.validate.field).uint64.gt = 0
  ];
  uint64 from_account_id = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).uint64.gt = 0
  ];
  uint64 to_account_id = 3 [
    (buf.validate.field).required = true,
    (buf.validate.field).uint64.gt = 0
  ];
  // int64 transfer_at = 5 [(buf.validate.field).int64.gt = 0 /* unix epoch, must be > 0 */];
  double amount = 6 [(buf.validate.field).double.gt = 0 /* must be positive */];
  double fee_amount = 8;
  string desc = 7 [(buf.validate.field).string.max_len = 1024 /* optional but capped length */];
}

message TransferCreateResponse {}

message AccountTypeListRequest {}
message AccountTypeItem {
  uint64 id = 1;
  string key = 2;
  string name = 3;
  string type = 4;
}
message AccountTypeListResponse {
  repeated AccountTypeItem data = 1;
}

message LabelListRequest {
  string keyword = 1;
}
message LabelListResponse {
  repeated common.v1.KeyName data = 1;
}

message AccountUpdateRequest {
  uint64 team_id = 1;
  uint64 id = 2;
  string name = 3;
  string number_id = 4;
  repeated common.v1.KeyName labels = 5;
}

message AccountUpdateResponse {}

message AccountDeleteRequest {
  uint64 team_id = 1 [(buf.validate.field).required = true];
  repeated uint64 account_ids = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).repeated.min_items = 1,
    (buf.validate.field).repeated.unique = true,
    (buf.validate.field).repeated.items.uint64.gt = 0,
    (buf.validate.field).repeated.max_items = 10
  ];
}

message AccountDeleteResponse {}

message PublicAccountItem {
  uint64 id = 1;
  uint64 team_id = 2;
  string name = 3;
  string number_id = 4;
  string account_type = 5;
}

message AccountItem {
  uint64 id = 1;
  uint64 team_id = 2;
  string name = 3;
  string number_id = 4;
  string account_type = 5;
  // @gotags: gorm:"-"
  repeated common.v1.KeyName labels = 6;
}

message AccountListRequest {
  uint64 team_id = 1;
  repeated string labels = 2;
  string keyword = 3;
}

message AccountListResponse {
  repeated AccountItem data = 2;
}

message AccountCreateRequest {
  uint64 team_id = 1 [(buf.validate.field).required = true];
  string name = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.max_len = 100
  ];
  string number_id = 3 [
    (buf.validate.field).required = true,
    (buf.validate.field).string.max_len = 100
  ];
  uint64 account_type_id = 4 [(buf.validate.field).required = true];
  repeated common.v1.KeyName labels = 5 [(buf.validate.field).repeated.max_items = 5];
}

message AccountCreateResponse {}
