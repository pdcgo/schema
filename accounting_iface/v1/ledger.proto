syntax = "proto3";
package accounting_iface.v1;

import "accounting_iface/v1/core.proto";
import "buf/validate/validate.proto";
import "common/v1/common.proto";
import "common/v1/shop.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/pdcgo/schema/services/accounting_iface/v1;accounting_iface";

service LedgerService {
  rpc EntryList(EntryListRequest) returns (EntryListResponse);
  rpc EntryListExtra(EntryListExtraRequest) returns (EntryListExtraResponse);
  rpc EntryListExport(EntryListExportRequest) returns (stream EntryListExportResponse);
  rpc TransactionDetail(TransactionDetailRequest) returns (TransactionDetailResponse);
}

message TransactionDetailRequest {
  uint64 id = 1 [(buf.validate.field).uint64.gt = 0];
}

message Transaction {
  uint64 id = 1;
  string ref_id = 2;
  uint64 team_id = 3;
  uint64 created_by_id = 4;
  string desc = 5;
  google.protobuf.Timestamp created = 6;
}

message TransactionDetailResponse {
  repeated EntryItem entries = 1;
  Transaction transaction = 2;
}

message EntryListExtraRequest {
  repeated uint64 tx_ids = 1 [
    (buf.validate.field).repeated.min_items = 1,
    (buf.validate.field).repeated.max_items = 100,
    (buf.validate.field).repeated.unique = true,
    (buf.validate.field).repeated.items.uint64.gt = 0
  ];
}

message TagList {
  repeated string list = 1;
}

message EntryListExtraResponse {
  map<uint64, string> map_cs = 1;
  map<uint64, string> map_supplier = 2;
  map<uint64, common.v1.ShopList> map_shop = 3;
  map<uint64, TagList> map_tag = 4;
  map<uint64, accounting_iface.v1.TypeLabelList> map_type_label = 5;
}

message EntryListExportResponse {
  string message = 1;
  int64 offset = 2;
  int64 total = 3;
  bytes data = 4;
}

enum EntryFieldSort {
  ENTRY_FIELD_SORT_UNSPECIFIED = 0;
  ENTRY_FIELD_SORT_ENTRYTIME = 1;
}

message EntryListSort {
  EntryFieldSort field = 1;
  common.v1.SortType type = 2;
}

message FilterExtra {
  uint64 customer_service_id = 1;
  uint64 shop_id = 2;
  uint64 supplier_id = 3;
}

message EntryListExportRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64.gt = 0];
  string account_key = 2 [(buf.validate.field).string.min_len = 1];
  uint64 account_team_id = 7;
  common.v1.MarketplaceType marketplace = 8;
  uint64 shop_id = 9;
  string keyword = 4;
  FilterExtra extra = 6;
  common.v1.TimeFilterRange time_range = 3 [(buf.validate.field).required = true];
}

message EntryListRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64.gt = 0];
  uint64 account_team_id = 8;
  common.v1.MarketplaceType marketplace = 9;
  uint64 shop_id = 10;
  string account_key = 2 [(buf.validate.field).string.min_len = 1];
  string keyword = 7;
  FilterExtra extra = 6;
  common.v1.TimeFilterRange time_range = 3 [(buf.validate.field).required = true];
  common.v1.PageFilter page = 4 [(buf.validate.field).required = true];
  EntryListSort sort = 5;
}

message EntryAccount {
  uint64 id = 1;
  uint64 team_id = 2;
  string account_key = 3;
  string name = 4;
}

message EntryItem {
  uint64 id = 1;
  uint64 account_id = 2;
  uint64 transaction_id = 11;
  int64 entry_time = 3;
  string desc = 5;
  double debit = 6;
  double credit = 7;
  double balance = 8;
  uint64 created_by_id = 10;

  EntryAccount account = 9;
}

message EntryListResponse {
  repeated EntryItem data = 1;
  common.v1.PageInfo page_info = 2;
}
