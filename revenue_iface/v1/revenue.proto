syntax = "proto3";
package revenue_iface.v1;

import "accounting_iface/v1/core.proto";
import "accounting_iface/v1/revenue.proto";
import "buf/validate/validate.proto";
import "common/v1/common.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/pdcgo/schema/services/revenue_iface/v1;revenue_iface";

service RevenueService {
  // rpc OnOrderAsync(OnOrderAsyncRequest) returns (OnOrderAsyncResponse);
  rpc OnOrder(OnOrderRequest) returns (OnOrderResponse);
  rpc OrderCancel(OrderCancelRequest) returns (OrderCancelResponse);

  // bagian receivable order
  rpc SellingReceivableAdjustment(SellingReceivableAdjustmentRequest) returns (SellingReceivableAdjustmentResponse);

  rpc OrderReturnAsync(OrderReturnAsyncRequest) returns (OrderReturnAsyncResponse);
  rpc OrderReturn(OrderReturnRequest) returns (OrderReturnResponse);
  rpc OrderCompleted(OrderCompletedRequest) returns (OrderCompletedResponse);
  rpc RevenueAdjustment(RevenueAdjustmentRequest) returns (RevenueAdjustmentResponse);

  // bagian withdrawal
  rpc Withdrawal(WithdrawalRequest) returns (WithdrawalResponse);
  // rpc WithdrawalGet(WithdrawalGetRequest) returns (WithdrawalGetResponse);

  rpc RevenueStream(stream RevenueStreamRequest) returns (RevenueStreamResponse);

  // penghasilan lain
  rpc RevenueOther(RevenueOtherRequest) returns (RevenueOtherResponse);
  rpc SellingExpenseOther(SellingExpenseOtherRequest) returns (SellingExpenseOtherResponse);
}

enum ReceivableAdjustmentType {
  RECEIVABLE_ADJUSTMENT_TYPE_UNSPECIFIED = 0;
  RECEIVABLE_ADJUSTMENT_TYPE_RETURN_COST = 1;
  RECEIVABLE_ADJUSTMENT_TYPE_FUND = 2;
  RECEIVABLE_ADJUSTMENT_TYPE_REFUND_LOST = 3;
  RECEIVABLE_ADJUSTMENT_TYPE_OTHER_COST = 4;
  RECEIVABLE_ADJUSTMENT_TYPE_OTHER_REVENUE = 5;
}

message SellingExpenseOtherRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64 = {gt: 0}];

  string external_expense_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 100
  }];

  ExtraLabelInfo label_info = 3 [(buf.validate.field).required = true];
  double amount = 4 [(buf.validate.field).double = {gt: 0}];
  string desc = 5 [(buf.validate.field).string = {
    min_len: 1
    max_len: 300
  }];
  google.protobuf.Timestamp at = 6 [(buf.validate.field).required = true];
}

message SellingExpenseOtherResponse {
  uint64 transaction_id = 1;
}

message SellingReceivableAdjustmentRequest {
  uint64 order_id = 1 [(buf.validate.field).uint64.gt = 0];
  string adj_ref_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 64
  }];
  uint64 team_id = 3 [(buf.validate.field).uint64.gt = 0];
  uint64 shop_id = 4 [(buf.validate.field).uint64.gt = 0];
  double amount = 5;
  bool only_rollback = 6;
  string desc = 7 [(buf.validate.field).string.min_len = 1];
  ReceivableAdjustmentType type = 8;
  google.protobuf.Timestamp at = 9 [(buf.validate.field).required = true];
  google.protobuf.Timestamp wd_at = 10 [(buf.validate.field).required = true];
}
message SellingReceivableAdjustmentResponse {
  uint64 transaction_id = 1;
}

enum RevenueAdjustmentType {
  REVENUE_ADJUSTMENT_TYPE_UNSPECIFIED = 0;
  REVENUE_ADJUSTMENT_TYPE_RETURN = 1;
}

message RevenueOtherRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64 = {gt: 0}];

  string external_revenue_id = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 100
  }];

  ExtraLabelInfo label_info = 3 [(buf.validate.field).required = true];
  double amount = 4 [(buf.validate.field).double = {gt: 0}];
  string desc = 5 [(buf.validate.field).string = {
    min_len: 1
    max_len: 300
  }];
  google.protobuf.Timestamp at = 6 [(buf.validate.field).required = true];
}

message RevenueOtherResponse {
  uint64 transaction_id = 1;
}

message WithdrawalGetRequest {}

message WithdrawalGetResponse {}

message RevenueStreamEventFund {
  double est_amount = 1 [(buf.validate.field).double.gt = 0];
  double amount = 2 [
    (buf.validate.field).required = true,
    (buf.validate.field).cel = {
      id: "amount_not_zero"
      message: "amount must not be zero"
      expression: "this != 0.00"
    }
  ];
  google.protobuf.Timestamp at = 3 [(buf.validate.field).required = true];
  string desc = 4 [(buf.validate.field).required = true];
  string order_id = 5 [(buf.validate.field).required = true];
}

message RevenueStreamEventAdjustment {
  double amount = 1 [(buf.validate.field).cel = {
    id: "non_zero_amount"
    message: "amount cannot be zero"
    expression: "this != 0.00"
  }];
  google.protobuf.Timestamp at = 2 [(buf.validate.field).required = true];
  string desc = 3 [(buf.validate.field).required = true];
  string order_id = 4;
  repeated string tags = 5;
  accounting_iface.v1.RevenueSource source = 6;
  // RevenueAdjustmentType type = 7;
}

message RevenueStreamEventWithdrawal {
  double amount = 1 [(buf.validate.field).double.gt = 0];
  google.protobuf.Timestamp at = 2 [(buf.validate.field).required = true];
  string desc = 3 [(buf.validate.field).required = true];
}

message RevenueStreamEventInit {
  string token = 1 [(buf.validate.field).required = true];
  uint64 team_id = 2 [(buf.validate.field).uint64.gt = 0];
  uint64 shop_id = 3 [(buf.validate.field).uint64.gt = 0];
  uint64 user_id = 4 [(buf.validate.field).uint64.gt = 0];
}

message RevenueStreamEvent {
  oneof kind {
    RevenueStreamEventInit init = 1;
    RevenueStreamEventFund fund = 2;
    RevenueStreamEventAdjustment adjustment = 3;
    RevenueStreamEventWithdrawal withdrawal = 4;
  }
}

message RevenueStreamRequest {
  RevenueStreamEvent event = 2 [(buf.validate.field).required = true];
}
message RevenueStreamResponse {}

message RevenueAdjustmentRequest {}
message RevenueAdjustmentResponse {}

message OrderCompletedRequest {}
message OrderCompletedResponse {}

enum ProblemType {
  PROBLEM_TYPE_UNSPECIFIED = 0;
  PROBLEM_TYPE_LOST = 1;
}

message OrderReturnRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64.gt = 0];
  uint64 order_id = 2 [(buf.validate.field).uint64.gt = 0];
  uint64 warehouse_id = 3 [(buf.validate.field).uint64.gt = 0];
  double order_amount = 4 [(buf.validate.field).double = {
    gt: 0 // must be > 0
  }];
  double stock_amount = 5 [(buf.validate.field).double = {
    gt: 0 // must be > 0
  }];
  ExtraLabelInfo label_info = 6 [(buf.validate.field).required = true];
  OrderInfo order_info = 7 [(buf.validate.field).required = true];
  common.v1.RequestFrom request_from = 8 [(buf.validate.field).enum = {defined_only: true}];
}
message OrderReturnResponse {}

message OrderReturnAsyncRequest {
  OrderReturnRequest data = 1 [(buf.validate.field).required = true];
}
message OrderReturnAsyncResponse {}

// message OrderAdjustmentRequest {}
// message OrderAdjustmentResponse {}

message WithdrawalRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64.gt = 0]; // must be > 0
  uint64 shop_id = 2 [(buf.validate.field).uint64.gt = 0]; // must be > 0
  // uint64 order_id = 3 [(buf.validate.field).uint64.gt = 0]; // must be > 0
  int64 at = 4 [(buf.validate.field).int64.gt = 0]; // timestamp must be > 0
  double amount = 5 [(buf.validate.field).double.gt = 0/* must be > 0 */ /* (buf.validate.field).double.lte = 1e12 // optional: cap max value for safety */];
}

message WithdrawalResponse {}

message OrderCancelRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64.gt = 0];
  uint64 order_id = 2 [(buf.validate.field).uint64.gt = 0];
  ExtraLabelInfo label_info = 12 [(buf.validate.field).required = true];
}
message OrderCancelResponse {}

message BorrowStock {
  uint64 team_id = 1;
  double amount = 2;
  double sell_amount = 3;
}

enum OrderEvent {
  ORDER_EVENT_UNSPECIFIED = 0;
  ORDER_EVENT_CREATED = 1;
  ORDER_EVENT_RETURN = 3;
}

message ExtraLabelInfo {
  uint64 cs_id = 1 [(buf.validate.field).uint64 = {gt: 0}];
  uint64 supplier_id = 2;
  uint64 shop_id = 3 [(buf.validate.field).uint64 = {gt: 0}];
  repeated string tags = 4;
  repeated accounting_iface.v1.TypeLabel type_labels = 5;
}

enum ProductSource {
  PRODUCT_SOURCE_UNSPECIFIED = 0;
  PRODUCT_SOURCE_DUMMY = 1;
  PRODUCT_SOURCE_WAREHOUSE = 2;
  PRODUCT_SOURCE_SUPPLIER = 3;
}

message OrderInfo {
  string receipt = 1;
  string external_order_id = 2;
  uint64 parent_external_order_id = 3;
}

message OnOrderAsyncRequest {
  OnOrderRequest data = 1 [(buf.validate.field).required = true];
}

message OnOrderAsyncResponse {}

message FakeOrderPayment {
  common.v1.PaymentMethod payment_method = 1 [(buf.validate.field).enum = {defined_only: true}];
  double amount = 2 [(buf.validate.field).double = {gt: 0}];
}

message SupplierPayment {
  common.v1.PaymentMethod payment_method = 1 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  double amount = 2 [(buf.validate.field).double = {gt: 0}];
}

message OnOrderRequest {
  string token = 1 [(buf.validate.field).required = true];
  uint64 team_id = 2 [(buf.validate.field).uint64 = {gt: 0}];
  uint64 warehouse_id = 3; // validate manual
  uint64 order_id = 4 [(buf.validate.field).required = true];
  bool is_custom_order = 17;

  ExtraLabelInfo label_info = 12 [(buf.validate.field).required = true];
  OrderInfo order_info = 13 [(buf.validate.field).required = true];
  OrderEvent event = 5 [(buf.validate.field).enum = {defined_only: true}];
  common.v1.MarketplaceType marketplace_type = 11 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  double order_amount = 6;
  double warehouse_fee = 7 [(buf.validate.field).double = {gte: 0}];
  // string description = 8 [(buf.validate.field).string = {max_len: 1024}];
  repeated BorrowStock borrow_stock = 9;
  double own_stock_amount = 10;
  ProductSource product_source = 14;

  oneof additional_payment {
    FakeOrderPayment fake_order_payment = 15;
    SupplierPayment supplier_payment = 16;
  }

  // ğŸ‘‡ cross-field validation: either borrow_stock > 0 OR own_stock_amount > 0
  option (buf.validate.message).cel = {
    id: "stock_source_required"
    expression: "(size(this.borrow_stock) > 0 || this.own_stock_amount > 0) || this.is_custom_order"
    message: "Either borrow_stock must not be empty or own_stock_amount must be greater than 0."
  };

  option (buf.validate.message).cel = {
    id: "warehouse_required_when_not_custom"
    expression: "this.is_custom_order || this.warehouse_id > 0"
    message: "warehouse_id is required when is_custom_order is false."
  };

  option (buf.validate.message).cel = {
    id: "order_amount_greater_than_zero"
    expression: "this.is_custom_order || this.order_amount > 0"
    message: "order_amount is required when is_custom_order is false."
  };
}

message OnOrderResponse {}
