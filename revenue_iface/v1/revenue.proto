syntax = "proto3";
package revenue_iface.v1;

import "accounting_iface/v1/core.proto";
import "buf/validate/validate.proto";
import "common/v1/common.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/pdcgo/schema/services/revenue_iface/v1;revenue_iface";

service RevenueService {
  rpc OnOrder(OnOrderRequest) returns (OnOrderResponse);
  rpc OrderCancel(OrderCancelRequest) returns (OrderCancelResponse);
  rpc OrderReturn(OrderReturnRequest) returns (OrderReturnResponse);
  rpc OrderCompleted(OrderCompletedRequest) returns (OrderCompletedResponse);
  rpc RevenueAdjustment(RevenueAdjustmentRequest) returns (RevenueAdjustmentResponse);
  rpc Withdrawal(WithdrawalRequest) returns (WithdrawalResponse);
  rpc RevenueStream(stream RevenueStreamRequest) returns (RevenueStreamResponse);
}

enum RevenueSource {
  REVENUE_SOURCE_UNSPECIFIED = 0;
  REVENUE_SOURCE_FUND = 1;
  REVENUE_SOURCE_AFFILIATE_COMMISION = 2;
  REVENUE_SOURCE_LOST_COMPENSATION = 3;
  REVENUE_SOURCE_COMPENSATION = 4;
  REVENUE_SOURCE_UNKNOWN_COMPENSATION = 5;
}

message RevenueStreamEventFund {
  double est_amount = 1 [(buf.validate.field).double.gt = 0];
  double amount = 2 [(buf.validate.field).double.gt = 0];
  google.protobuf.Timestamp at = 3 [(buf.validate.field).required = true];
  string desc = 4 [(buf.validate.field).required = true];
  string order_id = 5 [(buf.validate.field).required = true];
}

message RevenueStreamEventAdjustment {
  double amount = 1 [(buf.validate.field).cel = {
    id: "non_zero_amount"
    message: "amount cannot be zero"
    expression: "this != 0.00"
  }];
  google.protobuf.Timestamp at = 2 [(buf.validate.field).required = true];
  string desc = 3 [(buf.validate.field).required = true];
  string order_id = 4;
  repeated string tags = 5;
  RevenueSource source = 6;
}

message RevenueStreamEventWithdrawal {
  double amount = 1 [(buf.validate.field).double.gt = 0];
  google.protobuf.Timestamp at = 2 [(buf.validate.field).required = true];
  string desc = 3 [(buf.validate.field).required = true];
}

message RevenueStreamEventInit {
  string token = 1 [(buf.validate.field).required = true];
  uint64 team_id = 2 [(buf.validate.field).uint64.gt = 0];
  uint64 shop_id = 3 [(buf.validate.field).uint64.gt = 0];
  uint64 user_id = 4 [(buf.validate.field).uint64.gt = 0];
}

message RevenueStreamEvent {
  oneof kind {
    RevenueStreamEventInit init = 1;
    RevenueStreamEventFund fund = 2;
    RevenueStreamEventAdjustment adjustment = 3;
    RevenueStreamEventWithdrawal withdrawal = 4;
  }
}

message RevenueStreamRequest {
  RevenueStreamEvent event = 2 [(buf.validate.field).required = true];
}
message RevenueStreamResponse {}

message RevenueAdjustmentRequest {}
message RevenueAdjustmentResponse {}

message OrderCompletedRequest {}
message OrderCompletedResponse {}

enum ProblemType {
  PROBLEM_TYPE_UNSPECIFIED = 0;
  PROBLEM_TYPE_LOST = 1;
}

message OrderReturnRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64.gt = 0];
  uint64 order_id = 2 [(buf.validate.field).uint64.gt = 0];
  uint64 warehouse_id = 3 [(buf.validate.field).uint64.gt = 0];
  double order_amount = 4 [
    (buf.validate.field).double.gt = 0, // must be > 0
    (buf.validate.field).double.lte = 1e12 // optional: cap max value for safety
  ];
  double stock_amount = 5 [
    (buf.validate.field).double.gt = 0, // must be > 0
    (buf.validate.field).double.lte = 1e12 // optional: cap max value for safety
  ];
}
message OrderReturnResponse {}

// message OrderAdjustmentRequest {}
// message OrderAdjustmentResponse {}

message WithdrawalRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64.gt = 0]; // must be > 0
  uint64 shop_id = 2 [(buf.validate.field).uint64.gt = 0]; // must be > 0
  // uint64 order_id = 3 [(buf.validate.field).uint64.gt = 0]; // must be > 0
  int64 at = 4 [(buf.validate.field).int64.gt = 0]; // timestamp must be > 0
  double amount = 5 [
    (buf.validate.field).double.gt = 0, // must be > 0
    (buf.validate.field).double.lte = 1e12 // optional: cap max value for safety
  ];
}

message WithdrawalResponse {}

message OrderCancelRequest {
  uint64 team_id = 1 [(buf.validate.field).uint64.gt = 0];
  uint64 order_id = 2 [(buf.validate.field).uint64.gt = 0];
}
message OrderCancelResponse {}

message BorrowStock {
  uint64 team_id = 1;
  double amount = 2;
  double sell_amount = 3;
}

enum OrderEvent {
  ORDER_EVENT_UNSPECIFIED = 0;
  ORDER_EVENT_CREATED = 1;
  ORDER_EVENT_RETURN = 3;
}

message ExtraLabelInfo {
  uint64 cs_id = 1 [(buf.validate.field).uint64 = {gt: 0}];
  uint64 supplier_id = 2;
  uint64 shop_id = 3 [(buf.validate.field).uint64 = {gt: 0}];
  repeated string tags = 4;
  repeated accounting_iface.v1.TypeLabel type_labels = 5;
}

message OrderInfo {
  string receipt = 1;
  string external_order_id = 2;
}

message OnOrderRequest {
  string token = 1 [(buf.validate.field).required = true];
  uint64 team_id = 2 [(buf.validate.field).uint64 = {gt: 0}];
  uint64 warehouse_id = 3 [(buf.validate.field).uint64 = {gt: 0}];
  uint64 order_id = 4 [(buf.validate.field).required = true];
  ExtraLabelInfo label_info = 12 [(buf.validate.field).required = true];
  OrderInfo order_info = 13 [(buf.validate.field).required = true];
  OrderEvent event = 5 [(buf.validate.field).enum = {defined_only: true}];
  common.v1.MarketplaceType marketplace_type = 11 [(buf.validate.field).enum = {
    defined_only: true
    not_in: [0]
  }];
  double order_amount = 6 [(buf.validate.field).double = {gt: 0}];
  double warehouse_fee = 7 [(buf.validate.field).double = {gte: 0}];
  // string description = 8 [(buf.validate.field).string = {max_len: 1024}];
  repeated BorrowStock borrow_stock = 9;
  double own_stock_amount = 10;

  // ðŸ‘‡ cross-field validation: either borrow_stock > 0 OR own_stock_amount > 0
  option (buf.validate.message).cel = {
    id: "stock_source_required"
    expression: "size(this.borrow_stock) > 0 || this.own_stock_amount > 0"
    message: "Either borrow_stock must not be empty or own_stock_amount must be greater than 0."
  };
}

message OnOrderResponse {}
